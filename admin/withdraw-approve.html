<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin Approvals</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,sans-serif;background:#f9fafb;color:#1f2937}
.header{background:#fff;border-bottom:1px solid #e5e7eb;padding:32px 24px}.header h1{font-size:24px;font-weight:700;max-width:1200px;margin:0 auto}
.header p{color:#9ca3af;font-size:14px;max-width:1200px;margin:4px auto 0}.tabs-main{background:#fff;border-bottom:2px solid #e5e7eb;padding:0 24px}
.tabs-main-inner{max-width:1200px;margin:0 auto;display:flex;gap:4px}.tab-main{padding:16px 24px;background:0;border:0;cursor:pointer;font-size:14px;font-weight:600;color:#9ca3af;border-bottom:3px solid transparent;margin-bottom:-2px}
.tab-main.active{color:#10b981;border-bottom-color:#10b981}.stats{background:#fff;border-bottom:1px solid #e5e7eb;padding:20px 24px}
.stats-inner{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:24px}
.stat{text-align:center}.stat-val{font-size:28px;font-weight:700;color:#10b981}.stat-lbl{font-size:12px;color:#9ca3af;margin-top:4px;text-transform:uppercase}
.container{max-width:1200px;margin:0 auto;padding:24px}.section{display:none}.section.active{display:block}
.controls{display:flex;gap:16px;margin-bottom:24px;align-items:center}.tabs{display:flex;gap:8px;border-radius:8px;background:#fff;padding:4px;border:1px solid #e5e7eb}
.tab{padding:8px 14px;background:0;border:0;cursor:pointer;font-size:13px;font-weight:500;border-radius:6px;color:#9ca3af}.tab.active{background:#10b981;color:#fff}
.btn-refresh{background:#10b981;color:#fff;border:0;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;margin-left:auto}
.grid{display:grid;gap:16px}.card{background:#fff;border-radius:8px;padding:20px;border:1px solid #e5e7eb}.card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}.card-info h3{font-size:16px;font-weight:600;margin-bottom:2px}
.card-info p{font-size:13px;color:#9ca3af;margin:2px 0}.amount{background:#10b981;color:#fff;padding:6px 12px;border-radius:6px;font-weight:700;font-size:16px}
.details{background:#f9fafb;padding:12px;border-radius:6px;margin:12px 0;font-size:13px;display:grid;gap:8px}
.detail-row{display:flex;justify-content:space-between;gap:8px}.detail-lbl{font-weight:500;color:#9ca3af}.detail-val{font-family:monospace;word-break:break-all}
.proof{margin:12px 0;border-radius:8px;overflow:hidden;border:2px solid #e5e7eb;cursor:pointer}.proof img{width:100%;height:auto;display:block}
.badge{padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;width:fit-content}
.badge-pending{background:#fef3c7;color:#92400e}.badge-approved{background:#dcfce7;color:#166534}.badge-rejected{background:#fee2e2;color:#991b1b}
.actions{display:flex;gap:12px;margin-top:16px}.btn{flex:1;padding:9px 16px;border:0;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500}
.btn-approve{background:#22c55e;color:#fff}.btn-reject{background:#ef4444;color:#fff}.loading,.empty{text-align:center;padding:48px 20px;color:#9ca3af}
.empty h3{font-size:16px;margin-bottom:6px;color:#1f2937}.alert{position:fixed;top:20px;right:20px;z-index:1000;padding:12px 16px;border-radius:6px;font-size:13px;font-weight:500;color:#fff;animation:slideIn .3s}
.alert.success{background:#22c55e}.alert.error{background:#ef4444}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.85);align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}.modal-img{max-width:90%;max-height:90vh;border-radius:8px}
@media(max-width:640px){.header{padding:20px 16px}.header h1{font-size:20px}.stats-inner{grid-template-columns:1fr;gap:16px}.container{padding:16px}
.controls{flex-direction:column}.btn-refresh{margin-left:0}.card-header{flex-direction:column}.actions{flex-direction:column}}
</style>
</head>
<body>
<div class="header">
<div style="max-width:1200px;margin:0 auto">
<h1>Admin Approvals</h1>
<p>Review and manage funding & withdrawal requests</p>
</div>
</div>

<div class="tabs-main">
<div class="tabs-main-inner">
<button class="tab-main active" onclick="switchTab('funding')">Funding Requests</button>
<button class="tab-main" onclick="switchTab('withdrawals')">Withdrawal Requests</button>
</div>
</div>

<div class="stats" id="statsBar"></div>

<div class="container">
<div id="fundingSection" class="section active">
<div class="controls">
<div class="tabs">
<button class="tab active" onclick="filter('funding','all')">All</button>
<button class="tab" onclick="filter('funding','pending')">Pending</button>
<button class="tab" onclick="filter('funding','approved')">Approved</button>
<button class="tab" onclick="filter('funding','rejected')">Rejected</button>
</div>
<button class="btn-refresh" onclick="location.reload()">Refresh</button>
</div>
<div id="fundingGrid" class="grid"><div class="loading">Loading...</div></div>
</div>

<div id="withdrawalSection" class="section">
<div class="controls">
<div class="tabs">
<button class="tab active" onclick="filter('withdrawal','all')">All</button>
<button class="tab" onclick="filter('withdrawal','pending')">Pending</button>
<button class="tab" onclick="filter('withdrawal','approved')">Approved</button>
<button class="tab" onclick="filter('withdrawal','rejected')">Rejected</button>
</div>
<button class="btn-refresh" onclick="location.reload()">Refresh</button>
</div>
<div id="withdrawalGrid" class="grid"><div class="loading">Loading...</div></div>
</div>
</div>

<div id="imageModal" class="modal" onclick="this.classList.remove('active')">
<img id="modalImage" class="modal-img">
</div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import{getDatabase,ref,onValue,update,get}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import{getAuth,onAuthStateChanged}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import firebaseConfig from'./firebaseConfig.js';

const app=initializeApp(firebaseConfig),db=getDatabase(app),auth=getAuth(app);
let fundings={},withdrawals={},fFilter='all',wFilter='all',curTab='funding',admin;

const fmt=a=>`₦${a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',')}`;
const fDate=d=>new Date(d).toLocaleString();

window.switchTab=t=>{
curTab=t;
document.querySelectorAll('.tab-main').forEach(b=>b.classList.remove('active'));
event.target.classList.add('active');
document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
document.getElementById(t+'Section').classList.add('active');
updateStats();
};

window.filter=(type,f)=>{
if(type==='funding')fFilter=f;else wFilter=f;
event.target.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
type==='funding'?renderFunding():renderWithdrawal();
};

window.openImg=url=>{
document.getElementById('modalImage').src=url;
document.getElementById('imageModal').classList.add('active');
};

const updateStats=()=>{
const bar=document.getElementById('statsBar');
if(curTab==='funding'){
const pending=Object.values(fundings).filter(f=>f.status==='pending');
const total=pending.reduce((s,f)=>s+(f.amount||0),0);
const today=new Date().toDateString();
const proc=Object.values(fundings).filter(f=>f.processedDate&&new Date(f.processedDate).toDateString()===today).length;
bar.innerHTML=`<div class="stats-inner"><div class="stat"><div class="stat-val">${pending.length}</div><div class="stat-lbl">Pending</div></div><div class="stat"><div class="stat-val">${fmt(total)}</div><div class="stat-lbl">Total Pending</div></div><div class="stat"><div class="stat-val">${proc}</div><div class="stat-lbl">Processed Today</div></div></div>`;
}else{
const pending=Object.values(withdrawals).filter(w=>w.status==='pending');
const total=pending.reduce((s,w)=>s+(w.amount||0),0);
const today=new Date().toDateString();
const proc=Object.values(withdrawals).filter(w=>w.processedDate&&new Date(w.processedDate).toDateString()===today).length;
bar.innerHTML=`<div class="stats-inner"><div class="stat"><div class="stat-val">${pending.length}</div><div class="stat-lbl">Pending</div></div><div class="stat"><div class="stat-val">${fmt(total)}</div><div class="stat-lbl">Total Pending</div></div><div class="stat"><div class="stat-val">${proc}</div><div class="stat-lbl">Processed Today</div></div></div>`;
}
};

const renderFunding=()=>{
let list=Object.entries(fundings);
if(fFilter!=='all')list=list.filter(([_,f])=>f.status===fFilter);
const grid=document.getElementById('fundingGrid');
if(!list.length){grid.innerHTML=`<div class="empty"><h3>No ${fFilter} requests</h3></div>`;return}
grid.innerHTML=list.sort(([,a],[,b])=>(b.timestamp||0)-(a.timestamp||0)).map(([id,f])=>{
const st=f.status||'pending';
let proofHTML='';
if(f.proofBase64){
const src=`data:${f.proofFileType||'image/jpeg'};base64,${f.proofBase64}`;
proofHTML=`<div class="proof" onclick="openImg('${src}')"><img src="${src}" loading="lazy" alt="Payment Proof"></div>`;
}else if(f.proofURL){
proofHTML=`<div class="proof" onclick="openImg('${f.proofURL}')"><img src="${f.proofURL}" loading="lazy" alt="Payment Proof"></div>`;
}else{
proofHTML='<div style="background:#fef3c7;border:2px dashed #f59e0b;border-radius:8px;padding:20px;text-align:center;color:#92400e;font-size:13px">⚠️ No proof uploaded</div>';
}
return`<div class="card"><div class="card-header"><div class="card-info"><h3>${f.userName||'Unknown'}</h3><p>${f.userEmail||''}</p><p>${fDate(f.createdAt||f.timestamp)}</p></div><div class="amount">${fmt(f.amount||0)}</div></div><div class="details"><div class="detail-row"><span class="detail-lbl">Method:</span><span class="detail-val">${f.paymentMethod||'N/A'}</span></div><div class="detail-row"><span class="detail-lbl">Account:</span><span class="detail-val">${f.accountNumber||'N/A'}</span></div><div class="detail-row"><span class="detail-lbl">Name:</span><span class="detail-val">${f.accountName||'N/A'}</span></div>${f.proofFileName?`<div class="detail-row"><span class="detail-lbl">File:</span><span class="detail-val">${f.proofFileName}</span></div>`:''}<div class="detail-row"><span class="detail-lbl">Status:</span><span class="badge badge-${st}">${st}</span></div>${f.processedBy?`<div class="detail-row"><span class="detail-lbl">By:</span><span class="detail-val">${f.processedBy}</span></div>`:''}</div>${proofHTML}${st==='pending'?`<div class="actions"><button class="btn btn-approve" onclick="approveFund('${id}',${f.amount},'${f.userId}')">Approve</button><button class="btn btn-reject" onclick="rejectFund('${id}')">Reject</button></div>`:''}</div>`;
}).join('');
};

const renderWithdrawal=()=>{
let list=Object.entries(withdrawals);
if(wFilter!=='all')list=list.filter(([_,w])=>w.status===wFilter);
const grid=document.getElementById('withdrawalGrid');
if(!list.length){grid.innerHTML=`<div class="empty"><h3>No ${wFilter} withdrawals</h3></div>`;return}
grid.innerHTML=list.sort(([,a],[,b])=>new Date(b.requestDate)-new Date(a.requestDate)).map(([id,w])=>{
const st=w.status||'pending';
return`<div class="card"><div class="card-header"><div class="card-info"><h3>${w.userName||'Unknown'}</h3><p>${w.userEmail||''}</p><p>${fDate(w.requestDate)}</p></div><div class="amount">${fmt(w.amount||0)}</div></div><div class="details"><div class="detail-row"><span class="detail-lbl">User ID:</span><span class="detail-val">${(w.userId||'').substring(0,12)}...</span></div><div class="detail-row"><span class="detail-lbl">Method:</span><span class="detail-val">${w.method||'N/A'}</span></div><div class="detail-row"><span class="detail-lbl">Fee (2.5%):</span><span class="detail-val">${fmt(w.fee||0)}</span></div><div class="detail-row"><span class="detail-lbl">Status:</span><span class="badge badge-${st}">${st}</span></div>${w.processedBy?`<div class="detail-row"><span class="detail-lbl">By:</span><span class="detail-val">${w.processedBy}</span></div>`:''}</div>${st==='pending'?`<div class="actions"><button class="btn btn-approve" onclick="approveWith('${id}',${w.amount},'${w.userId}')">Approve</button><button class="btn btn-reject" onclick="rejectWith('${id}',${w.amount},'${w.userId}')">Reject</button></div>`:''}</div>`;
}).join('');
};

window.approveFund=async(id,amt,uid)=>{
if(!confirm(`Approve ${fmt(amt)}?`))return;
try{
const ts=new Date().toISOString();
const snap=await get(ref(db,`users/${uid}`));
if(!snap.exists()){showAlert('User not found','error');return}
const bal=snap.val().balance||0;
await update(ref(db),{
[`fundingRequests/${id}/status`]:'approved',
[`fundingRequests/${id}/processedDate`]:ts,
[`fundingRequests/${id}/processedBy`]:admin?.email||'Admin',
[`users/${uid}/balance`]:bal+amt
});
showAlert(`✓ Approved ${fmt(amt)}!`,'success');
}catch(e){showAlert('Failed: '+e.message,'error')}
};

window.rejectFund=async id=>{
if(!confirm('Reject this request?'))return;
try{
const ts=new Date().toISOString();
await update(ref(db),{
[`fundingRequests/${id}/status`]:'rejected',
[`fundingRequests/${id}/processedDate`]:ts,
[`fundingRequests/${id}/processedBy`]:admin?.email||'Admin'
});
showAlert('✓ Rejected!','success');
}catch(e){showAlert('Failed: '+e.message,'error')}
};

window.approveWith=async(id,amt,uid)=>{
if(!confirm(`Approve ${fmt(amt)}?`))return;
try{
const ts=new Date().toISOString();
const snap=await get(ref(db,`pendingWithdrawals/${id}`));
if(!snap.exists()){showAlert('Not found','error');return}
await update(ref(db),{
[`pendingWithdrawals/${id}/status`]:'approved',
[`pendingWithdrawals/${id}/processedDate`]:ts,
[`pendingWithdrawals/${id}/processedBy`]:admin?.email||'Admin',
[`users/${uid}/transactions/${id}/status`]:'approved',
[`users/${uid}/transactions/${id}/processedDate`]:ts
});
showAlert(`✓ Approved ${fmt(amt)}!`,'success');
}catch(e){showAlert('Failed: '+e.message,'error')}
};

window.rejectWith=async(id,amt,uid)=>{
if(!confirm(`Reject ${fmt(amt)}?`))return;
try{
const ts=new Date().toISOString();
const snap=await get(ref(db,`users/${uid}`));
if(!snap.exists()){showAlert('User not found','error');return}
const bal=snap.val().balance||0;
await update(ref(db),{
[`pendingWithdrawals/${id}/status`]:'rejected',
[`pendingWithdrawals/${id}/processedDate`]:ts,
[`pendingWithdrawals/${id}/processedBy`]:admin?.email||'Admin',
[`users/${uid}/transactions/${id}/status`]:'rejected',
[`users/${uid}/balance`]:bal+amt
});
showAlert(`✓ Rejected & refunded ${fmt(amt)}!`,'success');
}catch(e){showAlert('Failed: '+e.message,'error')}
};

const showAlert=(msg,type)=>{
const div=document.createElement('div');
div.className=`alert ${type}`;
div.textContent=msg;
document.body.appendChild(div);
setTimeout(()=>div.remove(),3000);
};

onAuthStateChanged(auth,u=>{if(u)admin=u});

onValue(ref(db,'fundingRequests'),snap=>{
fundings=snap.val()||{};
if(curTab==='funding'){updateStats();renderFunding()}
});

onValue(ref(db,'pendingWithdrawals'),snap=>{
withdrawals=snap.val()||{};
if(curTab==='withdrawals'){updateStats();renderWithdrawal()}
});
</script>
</body>
</html>
