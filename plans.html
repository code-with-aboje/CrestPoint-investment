<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Plans</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Inter,sans-serif;background:#f8fafc;min-height:100vh;padding:80px 20px 300px;color:#1e293b}
        .container{max-width:1200px;margin:0 auto}
        .header{text-align:center;margin-bottom:24px}
        .header h1{font-size:28px;font-weight:700;color:#0f172a;margin-bottom:6px}
        .header p{font-size:14px;color:#64748b}
        .balance{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:16px;border-radius:12px;text-align:center;margin-bottom:20px;box-shadow:0 2px 12px rgba(16,185,129,.2)}
        .balance-label{font-size:12px;opacity:.9;margin-bottom:4px}
        .balance-amount{font-size:32px;font-weight:700}
        .banner{padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px;display:none;align-items:center;gap:8px}
        .banner.show{display:flex}
        .banner i{font-size:14px}
        .error{background:#fee;border:1px solid #dc2626;color:#dc2626}
        .warning{background:#fef3c7;border:1px solid #f59e0b;color:#92400e}
        .info{background:#dbeafe;border:1px solid #3b82f6;color:#1e40af}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
        .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08);transition:all .2s;border:1px solid #e2e8f0;position:relative}
        .card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.1);border-color:#10b981}
        .card.featured{border-color:#10b981;background:linear-gradient(135deg,#fff,#f0fdf4)}
        .badge{position:absolute;top:12px;right:12px;background:#10b981;color:#fff;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase}
        .plan-name{font-size:18px;font-weight:700;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e2e8f0}
        .price{text-align:center;margin:12px 0;padding:12px;background:#f8fafc;border-radius:8px}
        .price-label{font-size:10px;color:#64748b;font-weight:600;text-transform:uppercase;margin-bottom:4px}
        .price-amount{font-size:28px;font-weight:700}
        .daily{background:#f0fdf4;border:1px solid #10b981;color:#059669;padding:8px;border-radius:6px;text-align:center;margin:10px 0;font-size:12px;font-weight:600}
        .features{list-style:none;margin:12px 0}
        .features li{padding:6px 0;color:#475569;display:flex;align-items:center;font-size:12px}
        .features i{color:#10b981;font-size:12px;margin-right:8px;flex-shrink:0}
        .btn{width:100%;padding:12px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;text-transform:uppercase}
        .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,.3)}
        .btn:disabled{opacity:.6;cursor:not-allowed;background:#94a3b8}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;backdrop-filter:blur(3px);padding:20px;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:12px;padding:20px;max-width:360px;width:100%;box-shadow:0 20px 40px rgba(0,0,0,.2)}
        .modal h3{font-size:16px;margin-bottom:12px;text-align:center;font-weight:700}
        .confirm{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #10b981;border-radius:6px;padding:12px;text-align:center;margin-bottom:12px}
        .confirm-label{color:#059669;font-size:11px;font-weight:600;margin-bottom:4px}
        .confirm-value{color:#10b981;font-size:28px;font-weight:700}
        .summary{background:#f8fafc;padding:10px;border-radius:6px;margin-bottom:10px}
        .row{display:flex;justify-content:space-between;padding:5px 0;font-size:12px}
        .row span{color:#64748b}
        .row strong{color:#0f172a;font-weight:600}
        .actions{display:flex;gap:8px;margin-top:12px}
        .modal-btn{flex:1;padding:10px;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
        .cancel{background:#f1f5f9;color:#475569}
        .confirm-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
        .modal-btn:disabled{opacity:.6;cursor:not-allowed}
        .err{background:#fee;border:1px solid #dc2626;color:#dc2626;padding:8px;border-radius:6px;font-size:11px;margin-top:8px;display:none}
        .err.show{display:block}
        .spinner{display:inline-block;width:12px;height:12px;border:2px solid #e0e0e0;border-top-color:#10b981;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading{text-align:center;padding:40px;color:#64748b}
        @media(max-width:768px){body{padding:60px 12px 200px}.header h1{font-size:24px}.grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Choose Your Investment Plan</h1>
            <p>Start growing your wealth with flexible options</p>
        </div>

        <div class="banner error" id="errorBanner">
            <i class="fas fa-exclamation-circle"></i>
            <div><strong>Error:</strong> <span id="errorMsg"></span></div>
        </div>

        <div class="banner warning" id="warningBanner">
            <i class="fas fa-exclamation-triangle"></i>
            <div><strong>Notice:</strong> <span id="warningMsg"></span></div>
        </div>

        <div class="banner info show">
            <i class="fas fa-lightbulb"></i>
            <div>Confirm your investment plan properly before investing.</div>
        </div>

        <div class="balance">
            <div class="balance-label">Available Balance</div>
            <div class="balance-amount" id="balance"><span class="spinner"></span></div>
        </div>

        <div id="loader" class="loading"><div class="spinner" style="width:24px;height:24px;border-width:3px"></div><div>Loading plans...</div></div>
        <div class="grid" id="grid"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <div class="confirm">
                <div class="confirm-label">Investment Amount</div>
                <div class="confirm-value" id="amt"></div>
            </div>
            <div class="summary">
                <div class="row"><span>Plan:</span><strong id="sp"></strong></div>
                <div class="row"><span>Daily Income:</span><strong id="sd"></strong></div>
                <div class="row"><span>Duration:</span><strong id="su"></strong></div>
            </div>
            <div class="err" id="err"></div>
            <div class="actions">
                <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn confirm-btn" id="btn">Invest Now</button>
            </div>
        </div>
    </div>

    <script type="module">
        import{onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import{ref,get,update,push}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import{auth,database}from"./lib/firebase.js";

        const P={starter:{cost:3000,income:750,dur:'30 days'},bronze:{cost:6000,income:1500,dur:'30 days'},silver:{cost:10000,income:2500,dur:'30 days'},gold:{cost:15000,income:4750,dur:'30 days'},platinum:{cost:25000,income:7000,dur:'30 days'}};
        const plans=[{id:'starter',name:'Starter Plan',badge:'Beginner'},{id:'bronze',name:'Bronze Plan',featured:1,badge:'Popular'},{id:'silver',name:'Silver Plan'},{id:'gold',name:'Gold Plan',featured:1,badge:'Best Value'},{id:'platinum',name:'Platinum Plan',badge:'Elite'}];
        let user,bal=0,sel,init=0,userData={};

        const showErr=m=>{document.getElementById('errorMsg').textContent=m;document.getElementById('errorBanner').classList.add('show')};
        const showWarn=m=>{document.getElementById('warningMsg').textContent=m;document.getElementById('warningBanner').classList.add('show')};
        const hideWarn=()=>document.getElementById('warningBanner').classList.remove('show');

        const render=()=>{
            const g=document.getElementById('grid');
            document.getElementById('loader').style.display='none';
            g.style.display='grid';
            plans.forEach(p=>{
                const c=P[p.id];
                const card=document.createElement('div');
                card.className=`card ${p.featured?'featured':''}`;
                card.innerHTML=`
                    ${p.badge?`<span class="badge">${p.badge}</span>`:''}
                    <div class="plan-name">${p.name}</div>
                    <div class="price"><div class="price-label">Investment Amount</div><div class="price-amount">₦${c.cost.toLocaleString()}</div></div>
                    <div class="daily"><i class="fas fa-coins"></i> Daily Income: ₦${c.income.toLocaleString()}</div>
                    <ul class="features">
                        <li><i class="fas fa-check-circle"></i>Investment: ₦${c.cost.toLocaleString()}</li>
                        <li><i class="fas fa-check-circle"></i>Daily Earnings: ₦${c.income.toLocaleString()}</li>
                        <li><i class="fas fa-check-circle"></i>Duration: ${c.dur}</li>
                        <li><i class="fas fa-check-circle"></i>Claim earnings anytime</li>
                        <li><i class="fas fa-check-circle"></i>Auto-completes at maturity</li>
                        <li><i class="fas fa-check-circle"></i>24/7 Support</li>
                    </ul>
                    <button class="btn" onclick="openPlan('${p.id}')"><i class="fas fa-rocket"></i> Invest Now</button>
                `;
                g.appendChild(card);
            });
        };

        const processReferralCommissions=async(investmentAmount,investorId,investorName)=>{
            try{
                const investorSnap=await get(ref(database,`users/${investorId}`));
                if(!investorSnap.exists())return;
                
                const investorData=investorSnap.val();
                const referredBy=investorData.referredBy;
                
                if(!referredBy)return;
                
                const level1Snap=await get(ref(database,`users/${referredBy}`));
                if(!level1Snap.exists())return;
                
                const level1Data=level1Snap.val();
                const level1Commission=investmentAmount*0.20;
                
                const level1Updates={
                    balance:(level1Data.balance||0)+level1Commission,
                    totalReferralEarnings:(level1Data.totalReferralEarnings||0)+level1Commission
                };
                
                const level1Refs=level1Data.referrals||[];
                const refIndex=level1Refs.findIndex(r=>r.userId===investorId);
                if(refIndex>=0){
                    level1Refs[refIndex].earned=(level1Refs[refIndex].earned||0)+level1Commission;
                    level1Refs[refIndex].lastInvestment=new Date().toISOString();
                    level1Updates.referrals=level1Refs;
                }
                
                await update(ref(database,`users/${referredBy}`),level1Updates);
                
                if(level1Data.referredBy){
                    const level2Snap=await get(ref(database,`users/${level1Data.referredBy}`));
                    if(level2Snap.exists()){
                        const level2Data=level2Snap.val();
                        const level2Commission=investmentAmount*0.02;
                        
                        const level2Updates={
                            balance:(level2Data.balance||0)+level2Commission,
                            totalReferralEarnings:(level2Data.totalReferralEarnings||0)+level2Commission
                        };
                        
                        const level2Refs=level2Data.referrals||[];
                        const l2RefIndex=level2Refs.findIndex(r=>r.userId===investorId);
                        if(l2RefIndex>=0){
                            level2Refs[l2RefIndex].earned=(level2Refs[l2RefIndex].earned||0)+level2Commission;
                            level2Refs[l2RefIndex].lastInvestment=new Date().toISOString();
                            level2Updates.referrals=level2Refs;
                        }else{
                            level2Refs.push({
                                userId:investorId,
                                name:investorName,
                                level:2,
                                earned:level2Commission,
                                joinedAt:investorData.createdAt||new Date().toISOString(),
                                lastInvestment:new Date().toISOString()
                            });
                            level2Updates.referrals=level2Refs;
                        }
                        
                        await update(ref(database,`users/${level1Data.referredBy}`),level2Updates);
                    }
                }
            }catch(e){
                console.error('Referral commission error:',e);
            }
        };

        const initApp=async()=>{
            try{
                init=1;
                onAuthStateChanged(auth,async u=>{
                    if(!u){
                        showWarn('Not logged in. Log in to invest.');
                        document.getElementById('balance').textContent='₦0.00';
                        user=null;bal=0;return;
                    }
                    hideWarn();user=u;
                    const s=await get(ref(database,'users/'+u.uid));
                    if(s.exists()){
                        userData=s.val();
                        bal=userData.balance||0;
                        document.getElementById('balance').textContent='₦'+bal.toLocaleString('en-NG',{minimumFractionDigits:2});
                    }else{document.getElementById('balance').textContent='₦0.00';bal=0}
                });
            }catch(e){
                showErr('Firebase error: '+e.message);
                document.getElementById('balance').textContent='₦0.00';
            }
        };

        window.openPlan=id=>{
            sel=plans.find(p=>p.id===id);
            const c=P[id];
            document.getElementById('modalTitle').textContent=`Confirm ${sel.name}`;
            document.getElementById('amt').textContent='₦'+c.cost.toLocaleString();
            document.getElementById('sp').textContent=sel.name;
            document.getElementById('sd').textContent='₦'+c.income.toLocaleString();
            document.getElementById('su').textContent=c.dur;
            document.getElementById('modal').classList.add('active');
            document.getElementById('err').classList.remove('show');
        };

        window.closeModal=()=>document.getElementById('modal').classList.remove('active');

        document.getElementById('btn').onclick=async()=>{
            const c=P[sel.id],btn=document.getElementById('btn'),err=document.getElementById('err');
            if(!user){err.textContent='Please log in.';err.classList.add('show');return}
            if(!init){err.textContent='Firebase not ready.';err.classList.add('show');return}
            if(bal<c.cost){err.textContent='Insufficient funds. Fund wallet.';err.classList.add('show');return}
            btn.disabled=1;btn.innerHTML='<span class="spinner"></span> Processing...';
            try{
                const now=Date.now();
                const userRef=ref(database,'users/'+user.uid);
                const snapshot=await get(userRef);
                const currentData=snapshot.val()||{};
                const invKey=push(ref(database,`users/${user.uid}/investments`)).key;
                const updates={
                    balance:bal-c.cost,
                    [`investments/${invKey}`]:{
                        planId:sel.id,planName:sel.name,amount:c.cost,dailyIncome:c.income,
                        duration:c.dur,startDate:now,maturityDate:now+(86400000*30),
                        status:'active',totalClaimed:0
                    }
                };
                await update(userRef,updates);
                
                await processReferralCommissions(c.cost,user.uid,currentData.fullName||currentData.email||'User');
                
                bal=bal-c.cost;
                document.getElementById('balance').textContent='₦'+bal.toLocaleString('en-NG',{minimumFractionDigits:2});
                alert('✓ Investment successful!');closeModal();
            }catch(e){err.textContent='Error: '+e.message;err.classList.add('show')}
            finally{btn.disabled=0;btn.innerHTML='Invest Now'}
        };

        document.addEventListener('DOMContentLoaded',()=>{render();initApp()});
    </script>
</body>
        </html>
