<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Investment Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,sans-serif;background:#fafafa;min-height:100vh;padding:60px 20px 100px}.container{max-width:500px;margin:0 auto;padding-bottom:200px}.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:20px}.dash-card{background:linear-gradient(135deg,#10b981,#059669);border-radius:24px;padding:24px;box-shadow:0 8px 32px rgba(16,185,129,.25);position:relative;overflow:hidden;margin-bottom:20px;border:1px solid rgba(255,255,255,.2)}.dash-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,transparent 40%,rgba(255,255,255,.25) 50%,transparent 60%,transparent);animation:shine 3s infinite}@keyframes shine{to{transform:translate(100%,100%) rotate(45deg)}}.card-content{position:relative;z-index:1}.txt-w{color:#fff}.txt-s{color:#64748b;font-size:12px;font-weight:500;text-transform:uppercase}.txt-l{font-size:36px;font-weight:700}.txt-m{font-size:18px;font-weight:600}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.btn{width:100%;padding:10px;background:#10b981;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}.btn:hover{background:#059669}.btn:disabled{background:#94a3b8;cursor:not-allowed;opacity:.6}.btn-row{display:flex;gap:10px;margin-top:16px}.btn-w{flex:1;background:#fff;color:#10b981;border:none;border-radius:12px;padding:12px;font-size:14px;font-weight:600;cursor:pointer}.btn-w:hover{transform:translateY(-2px)}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}.modal-content{background:#fff;margin:5% auto;padding:16px;border-radius:12px;max-width:360px;box-shadow:0 4px 16px rgba(0,0,0,.2);max-height:85vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #e2e8f0}.close-btn{background:none;border:none;font-size:24px;color:#64748b;cursor:pointer}.input-group{margin:10px 0}.input-label{font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;display:block;text-transform:uppercase}.input-field{width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px}.file-upload{border:2px dashed #e2e8f0;border-radius:8px;padding:12px;text-align:center;cursor:pointer;transition:all .3s;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center}.file-upload:hover,.file-upload.has-file{border-color:#10b981;background:#f0fdf4}.file-upload input{display:none}.file-preview{margin-top:10px;border-radius:8px}.upload-success{background:#dcfce7;border:2px solid #10b981;border-radius:8px;padding:12px;text-align:center;margin-top:8px;display:none}.spinner{display:inline-block;width:12px;height:12px;border:2px solid #e0e0e0;border-top-color:#10b981;border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.ref-card{background:linear-gradient(135deg,#8b5cf6,#6d28d9);border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 4px 16px rgba(139,92,246,.2)}.ref-box{background:rgba(255,255,255,.2);border-radius:6px;padding:10px;display:flex;justify-content:space-between;align-items:center;margin:10px 0}.stat-trend{color:#10b981;font-size:11px;font-weight:600;margin-top:4px}.plan-item{background:#f8fafc;border-left:4px solid #10b981;border-radius:8px;padding:14px;margin-bottom:12px}.plan-header{display:flex;justify-content:space-between;margin-bottom:10px}.plan-status{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;background:#dcfce7;color:#059669}.pending-box{text-align:center;padding:20px;background:#fef3c7;border-radius:12px;margin-bottom:16px}.account-info{background:#f8fafc;padding:10px;border-radius:6px;margin-bottom:10px;border:1px solid #e2e8f0}.info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #e2e8f0}.info-row:last-child{border:0}.copy-btn{background:none;border:1px solid #e2e8f0;color:#64748b;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:10px}.copy-btn:hover{background:#f8fafc}</style>
</head>
<body>
<div class="container">
<div class="dash-card">
<div class="card-content">
<div class="txt-m txt-w" id="userName"><span class="spinner"></span> Loading...</div>
<div style="color:rgba(255,255,255,.85);font-size:13px;margin:8px 0 6px">Total Balance</div>
<div class="txt-l txt-w" id="totalBalance"><span class="spinner"></span></div>
<div class="txt-w" style="font-size:14px;font-weight:600;margin-top:6px" id="balanceChange"><span class="spinner"></span></div>
<div class="btn-row">
<button class="btn-w" onclick="openModal()"><i class="fas fa-wallet"></i> Fund</button>
<button class="btn-w" onclick="location.href='/plans.html'"><i class="fas fa-chart-line"></i> Invest</button>
</div>
</div>
</div>
<div class="ref-card" id="refCard" style="display:none">
<div class="txt-m txt-w" style="margin-bottom:10px"><i class="fas fa-users"></i> Referral Program</div>
<div class="ref-box">
<div><div style="color:rgba(255,255,255,.85);font-size:11px;margin-bottom:4px">YOUR CODE</div><div class="txt-w" style="font-size:16px;font-weight:700;letter-spacing:1px" id="refCode">LOADING...</div></div>
<button class="copy-btn" style="background:#fff;color:#8b5cf6" onclick="copyRefCode()"><i class="fas fa-copy"></i></button>
</div>
<div style="background:#fff;color:#8b5cf6;padding:8px;border-radius:6px;text-align:center;font-size:12px;font-weight:600;cursor:pointer" onclick="shareRefLink()"><i class="fas fa-share-alt"></i> Share Referral Link</div>
<div class="grid-2" style="margin-top:10px">
<div style="background:rgba(255,255,255,.15);border-radius:6px;padding:8px;text-align:center"><div style="color:rgba(255,255,255,.85);font-size:10px;margin-bottom:3px">Total Referrals</div><div class="txt-w txt-m" id="refCount">0</div></div>
<div style="background:rgba(255,255,255,.15);border-radius:6px;padding:8px;text-align:center"><div style="color:rgba(255,255,255,.85);font-size:10px;margin-bottom:3px">Total Earned</div><div class="txt-w txt-m" id="refEarnings">‚Ç¶0</div></div>
</div>
<div id="refList" style="margin-top:10px"></div>
</div>
<div class="grid-2">
<div class="card">
<div class="txt-s">Invested</div>
<div style="color:#0f172a;font-size:20px;font-weight:700;margin:6px 0" id="invested"><span class="spinner"></span></div>
<div class="stat-trend" id="investedCount"><span class="spinner"></span></div>
</div>
<div class="card">
<div class="txt-s">Total Claimed</div>
<div style="color:#0f172a;font-size:20px;font-weight:700;margin:6px 0" id="totalClaimed"><span class="spinner"></span></div>
<div class="stat-trend">Total earnings</div>
</div>
</div>
<div class="card" id="pendingSection" style="display:none">
<div style="font-size:14px;font-weight:600;color:#0f172a;margin-bottom:16px"><i class="fas fa-hand-holding-usd"></i> Pending Claims</div>
<div class="pending-box">
<div style="color:#92400e;font-size:12px;font-weight:600;margin-bottom:8px;text-transform:uppercase">Total Claimable</div>
<div style="color:#f59e0b;font-size:32px;font-weight:700" id="totalPending">‚Ç¶0.00</div>
</div>
<button class="btn" id="claimAllBtn" onclick="claimAll()">Claim All Earnings</button>
<div id="claimCooldown" style="display:none;color:#f59e0b;font-size:11px;margin-top:6px;font-weight:600;text-align:center"></div>
</div>
<div class="card">
<div style="font-size:14px;font-weight:600;color:#0f172a;margin-bottom:16px"><i class="fas fa-chart-line"></i> Active Investment Plans</div>
<div id="plansList"><div style="text-align:center;padding:20px;color:#94a3b8">No active plans</div></div>
</div>
</div>
<div id="fundModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 style="font-size:15px;font-weight:600;color:#0f172a">Fund Account</h2>
<button class="close-btn" onclick="closeModal()">√ó</button>
</div>
<div class="account-info">
<div class="info-row"><div><div class="txt-s" style="margin-bottom:4px;font-size:10px">Bank</div><div style="font-size:12px;color:#0f172a;font-weight:600">Monie Point</div></div></div>
<div class="info-row"><div><div class="txt-s" style="margin-bottom:4px;font-size:10px">Account Number</div><div style="font-size:12px;color:#0f172a;font-weight:600">9014749939</div></div><button class="copy-btn" onclick="copyText('9014749939')">Copy</button></div>
<div class="info-row"><div><div class="txt-s" style="margin-bottom:4px;font-size:10px">Account Name</div><div style="font-size:12px;color:#0f172a;font-weight:600">Jerry Chidera Boi</div></div></div>
</div>
<div class="input-group">
<label class="input-label" style="font-size:10px">Amount Sent (‚Ç¶)</label>
<input type="number" id="amountSent" class="input-field" placeholder="Enter amount" min="1" step="0.01">
</div>
<div class="input-group">
<label class="input-label" style="font-size:10px">Upload Payment Proof <span style="color:#ef4444">*</span></label>
<label for="proofUpload" class="file-upload" id="fileUploadArea">
<div style="width:36px;height:36px;background:#dcfce7;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:6px">
<i class="fas fa-cloud-upload-alt" style="font-size:18px;color:#10b981"></i>
</div>
<div style="font-size:11px;color:#64748b;font-weight:500">Click to upload screenshot</div>
<div style="font-size:9px;color:#94a3b8;margin-top:3px">JPG, PNG or PDF (Max 5MB)</div>
<input type="file" id="proofUpload" accept="image/*,.pdf" onchange="handleFileSelect(event)">
</label>
<div id="filePreview" class="file-preview" style="display:none"></div>
<div id="uploadSuccess" class="upload-success">
<i class="fas fa-check-circle" style="color:#059669;font-size:20px;margin-bottom:6px"></i>
<div style="color:#059669;font-size:12px;font-weight:600">Payment proof uploaded! ‚úì</div>
<div style="font-size:10px;color:#059669;margin-top:3px">Submitted for verification</div>
</div>
</div>
<button class="btn" id="submitBtn" onclick="submitFunding()" disabled>Confirm Payment</button>
</div>
</div>
<script type="module">
 import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import{getDatabase,ref,get,update,push,onValue}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
import{auth,database}from"./lib/firebase.js";
let user,plans={},userData={},selectedFile=null;
window.openModal=()=>document.getElementById('fundModal').style.display='block';
window.closeModal=()=>{document.getElementById('fundModal').style.display='none';document.getElementById('amountSent').value='';selectedFile=null;document.getElementById('filePreview').style.display='none';document.getElementById('filePreview').innerHTML='';document.getElementById('uploadSuccess').style.display='none';document.getElementById('fileUploadArea').classList.remove('has-file');document.getElementById('fileUploadArea').style.display='flex';document.getElementById('submitBtn').disabled=true;document.getElementById('submitBtn').textContent='Confirm Payment'};
window.handleFileSelect=e=>{const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){alert('File too large. Max 5MB');return}selectedFile=file;const preview=document.getElementById('filePreview'),area=document.getElementById('fileUploadArea');area.classList.add('has-file');const fn=file.name.length>35?file.name.substring(0,32)+'...':file.name;const icon=file.type.startsWith('image/')?'fa-image':'fa-file-pdf';preview.innerHTML=`<div style="padding:10px;background:#f0fdf4;color:#059669;border-radius:6px;font-size:12px;border:1px solid #10b981;margin-top:6px;display:flex;align-items:center;gap:8px"><i class="fas ${icon}"></i><span style="font-weight:500">${fn}</span></div>`;preview.style.display='block';checkFormValid()};
const checkFormValid=()=>{const amt=document.getElementById('amountSent').value;document.getElementById('submitBtn').disabled=!(amt&&parseFloat(amt)>0&&selectedFile)};
document.getElementById('amountSent').addEventListener('input',checkFormValid);
window.copyText=async t=>{try{await navigator.clipboard.writeText(t);alert('‚úÖ Copied: '+t)}catch{const i=document.createElement('input');i.value=t;document.body.appendChild(i);i.select();document.execCommand('copy');document.body.removeChild(i);alert('‚úÖ Copied: '+t)}};
window.copyRefCode=()=>copyText(userData.referralCode||'');
window.shareRefLink=()=>{const link=`${window.location.origin}/register.html?ref=${userData.referralCode}`,msg=`Join Crest Point Investment with my referral code and earn bonus! Use code: ${userData.referralCode}\n\n${link}`;if(navigator.share){navigator.share({title:'Join Crest Point',text:msg}).catch(e=>copyText(link))}else copyText(link)};
window.submitFunding=async()=>{if(!user||!selectedFile)return;const amt=parseFloat(document.getElementById('amountSent').value);if(!amt||amt<=0){alert('Please enter a valid amount');return}const btn=document.getElementById('submitBtn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Uploading...';try{console.log('Converting file to base64...');const base64Data=await new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result.split(',')[1]);reader.onerror=reject;reader.readAsDataURL(selectedFile)});console.log('File converted to base64');btn.textContent='Saving to database...';const reqData={userId:user.uid,userEmail:user.email,userName:user.displayName||user.email,amount:amt,paymentMethod:'Monie Point',accountNumber:'9014749939',accountName:'Jerry Chidera Boi',proofFileName:selectedFile.name,proofFileType:selectedFile.type,proofFileSize:selectedFile.size,proofBase64:base64Data,status:'pending',createdAt:new Date().toISOString(),timestamp:Date.now()};console.log('Saving to database...');const dbRef=await push(ref(database,'fundingRequests'),reqData);console.log('Saved successfully! Key:',dbRef.key);document.getElementById('fileUploadArea').style.display='none';document.getElementById('filePreview').style.display='none';document.getElementById('uploadSuccess').style.display='block';btn.style.display='none';setTimeout(()=>{closeModal();alert('‚úÖ Payment submitted! ID: '+dbRef.key.substring(0,8)+'. Verification within 24hrs.')},2500)}catch(e){console.error('Upload error:',e);alert('‚ùå Failed: '+e.message);btn.disabled=false;btn.innerHTML='Confirm Payment'}};
const calcPending=p=>{const now=Date.now();if(now>=p.maturityDate)return Math.max(0,p.dailyIncome-(p.totalClaimed||0));const elapsed=now-p.startDate,daysPassed=elapsed/86400000,earned=p.dailyIncome*daysPassed;return Math.max(0,earned-(p.totalClaimed||0))};
const canClaim=p=>{if(!p.lastClaim)return true;return(Date.now()-p.lastClaim)/3600000>=24};
const getTimeUntilClaim=p=>{if(!p.lastClaim)return null;const hoursSince=(Date.now()-p.lastClaim)/3600000;if(hoursSince>=24)return null;const remaining=24-hoursSince,hrs=Math.floor(remaining),mins=Math.floor((remaining-hrs)*60);return`${hrs}h ${mins}m`};
window.claimEarnings=async id=>{if(!user)return;const p=plans[id];if(!p||!canClaim(p)){alert('You can only claim once every 24 hours');return}const amt=calcPending(p);if(amt<1)return;try{const snap=await get(ref(database,`users/${user.uid}`)),d=snap.val(),claimed=(p.totalClaimed||0)+amt;await update(ref(database,`users/${user.uid}`),{balance:(d.balance||0)+amt,totalClaimed:(d.totalClaimed||0)+amt,[`investments/${id}/totalClaimed`]:claimed,[`investments/${id}/lastClaim`]:Date.now()});alert(`‚úÖ Successfully claimed ‚Ç¶${amt.toFixed(2)}!`)}catch{alert('Failed to claim. Try again.')}};
window.claimAll=async()=>{if(!user||!plans)return;let total=0;const updates={},now=Date.now();Object.entries(plans).forEach(([id,p])=>{if(p.status!=='active'||!canClaim(p))return;const pending=calcPending(p);if(pending>=1){total+=pending;const claimed=(p.totalClaimed||0)+pending;updates[`investments/${id}/totalClaimed`]=claimed;updates[`investments/${id}/lastClaim`]=now}});if(total<1)return alert('No earnings to claim or cooldown period active');try{const snap=await get(ref(database,`users/${user.uid}`)),d=snap.val();await update(ref(database,`users/${user.uid}`),{...updates,balance:(d.balance||0)+total,totalClaimed:(d.totalClaimed||0)+total});alert(`‚úÖ Successfully claimed ‚Ç¶${total.toFixed(2)}!`)}catch{alert('Failed to claim. Try again.')}};
const generateCode=()=>Math.random().toString(36).substring(2,8).toUpperCase();
const updateUI=async d=>{userData=d;document.getElementById('userName').textContent=d.fullName||d.email?.split('@')[0]||'Investor';document.getElementById('totalBalance').textContent=`‚Ç¶${(d.balance||0).toLocaleString('en-NG',{minimumFractionDigits:2})}`;const investments=d.investments||{};let totalInvested=0;Object.values(investments).forEach(inv=>{if(inv.status==='active')totalInvested+=inv.amount});document.getElementById('balanceChange').textContent=`‚Ç¶${(d.balance||0).toLocaleString('en-NG',{minimumFractionDigits:2})} Available`;document.getElementById('invested').textContent=`‚Ç¶${totalInvested.toLocaleString('en-NG',{minimumFractionDigits:2})}`;document.getElementById('totalClaimed').textContent=`‚Ç¶${(d.totalClaimed||0).toLocaleString('en-NG',{minimumFractionDigits:2})}`;const activeCount=Object.values(investments).filter(i=>i.status==='active').length;document.getElementById('investedCount').textContent=`${activeCount} active plan${activeCount!==1?'s':''}`;if(!d.referralCode&&user){const newCode=generateCode();try{await update(ref(database,`users/${user.uid}`),{referralCode:newCode});await update(ref(database,`referralCodes/${newCode}`),{userId:user.uid,createdAt:new Date().toISOString()});d.referralCode=newCode}catch(e){console.error('Failed to generate referral code:',e)}}document.getElementById('refCard').style.display='block';document.getElementById('refCode').textContent=d.referralCode||'LOADING...';document.getElementById('refCount').textContent=(d.referrals||[]).length;document.getElementById('refEarnings').textContent=`‚Ç¶${(d.totalReferralEarnings||0).toLocaleString('en-NG')}`;const refList=document.getElementById('refList');if((d.referrals||[]).length>0){refList.innerHTML=(d.referrals||[]).slice(0,5).map(r=>`<div style="background:rgba(255,255,255,.15);border-radius:6px;padding:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center"><div><div style="color:#fff;font-size:12px;font-weight:500">${r.name}</div><div style="color:rgba(255,255,255,.7);font-size:10px">${new Date(r.joinedAt).toLocaleDateString()}</div></div><div style="color:#fff;font-weight:600;font-size:13px">‚Ç¶40</div></div>`).join('')}plans=investments;const arr=Object.entries(plans).map(([id,p])=>({id,...p}));let totalPending=0,earliestClaim=null;if(arr.length>0){document.getElementById('plansList').innerHTML=arr.map(p=>{const pending=calcPending(p),claimable=canClaim(p),timeLeft=getTimeUntilClaim(p);if(p.status==='active'){totalPending+=pending;if(!claimable&&(!earliestClaim||p.lastClaim<earliestClaim))earliestClaim=p.lastClaim}return`<div class="plan-item"><div class="plan-header"><div><h4 style="color:#0f172a;font-size:14px;margin-bottom:4px;font-weight:600">${p.planName}</h4><span class="plan-status">${p.status==='active'?'‚óè Active':'‚úì Completed'}</span></div><div style="color:#0f172a;font-size:14px;font-weight:600">‚Ç¶${p.amount.toLocaleString('en-NG',{minimumFractionDigits:2})}</div></div>${p.status==='active'?`<button class="btn" style="padding:10px;font-size:13px;font-weight:600;margin-top:10px"${!claimable||pending<1?' disabled':''} onclick="claimEarnings('${p.id}')">${!claimable?`‚è∞ Wait ${timeLeft}`:pending>=1?`üí∞ Claim ‚Ç¶${pending.toFixed(2)}`:'Nothing to Claim Yet'}</button>`:''}</div>`}).join('');if(totalPending>=1||earliestClaim){document.getElementById('pendingSection').style.display='block';document.getElementById('totalPending').textContent=`‚Ç¶${totalPending.toFixed(2)}`;const allClaimable=!earliestClaim||canClaim({lastClaim:earliestClaim});document.getElementById('claimAllBtn').disabled=!allClaimable||totalPending<1;if(!allClaimable){const remaining=getTimeUntilClaim({lastClaim:earliestClaim});document.getElementById('claimCooldown').style.display='block';document.getElementById('claimCooldown').textContent=`‚è∞ Next claim available in ${remaining}`}else{document.getElementById('claimCooldown').style.display='none'}}}};
onAuthStateChanged(auth,u=>{if(u){user=u;onValue(ref(database,`users/${u.uid}`),s=>{if(s.exists())updateUI(s.val())})}else location.href='/login.html'});
</script>
</body>
</html>
